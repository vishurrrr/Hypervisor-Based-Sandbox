name: SafeBox CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake make g++ python3 python3-pip libgtest-dev
          pip install pytest psutil
      
      - name: Build C++ project
        run: |
          mkdir -p build
          cd build
          cmake ..
          make
      
      - name: Run C++ unit tests
        run: |
          cd build
          ./safebox-host-tests
      
      - name: Run Python agent tests
        run: |
          pytest tests/test_agent.py -v
      
      - name: Run integration tests
        run: |
          bash tests/integration_test.sh

  linting:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Install linters
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck shellcheck python3-pylint
      
      - name: Lint C++ code
        run: cppcheck --enable=all --suppress=missingIncludeSystem src/host/
      
      - name: Lint shell scripts
        run: shellcheck scripts/*.sh tests/*.sh || true
      
      - name: Lint Python code
        run: python3 -m py_compile agent/agent.py tests/test_agent.py
