#!/usr/bin/env python3
"""
SafeBox Malware Signatures Database
Comprehensive detection patterns for various malware types
"""

# ===== MALWARE SIGNATURES =====
MALWARE_SIGNATURES = {
    # File-based signatures (hashes)
    'file_hashes': {
        'd41d8cd98f00b204e9800998ecf8427e': 'Generic Trojan',
        '5d41402abc4b2a76b9719d911017c592': 'Ransomware',
        'c20ad4d76fe97759aa27a0c99bff6710': 'Botnet',
    },
    
    # Process name patterns
    'process_patterns': {
        # Trojans
        r'^svchost\.exe$': {'type': 'Trojan', 'severity': 'HIGH', 'family': 'Generic Trojan'},
        r'^lsass\.exe$': {'type': 'Trojan', 'severity': 'HIGH', 'family': 'Credential Stealer'},
        r'^rundll32\.exe$': {'type': 'Trojan', 'severity': 'HIGH', 'family': 'DLL Injector'},
        r'^conhost\.exe$': {'type': 'Trojan', 'severity': 'MEDIUM', 'family': 'Console Host'},
        
        # Ransomware
        r'.*ransomware.*': {'type': 'Ransomware', 'severity': 'CRITICAL', 'family': 'Ransomware'},
        r'.*crypt.*': {'type': 'Ransomware', 'severity': 'CRITICAL', 'family': 'Encryption Malware'},
        r'.*encrypt.*': {'type': 'Ransomware', 'severity': 'CRITICAL', 'family': 'File Encryptor'},
        r'.*wannacry.*': {'type': 'Ransomware', 'severity': 'CRITICAL', 'family': 'WannaCry'},
        
        # Worms
        r'.*worm.*': {'type': 'Worm', 'severity': 'HIGH', 'family': 'Generic Worm'},
        r'.*selfprop.*': {'type': 'Worm', 'severity': 'HIGH', 'family': 'Self-Propagating'},
        r'.*conficker.*': {'type': 'Worm', 'severity': 'HIGH', 'family': 'Conficker'},
        
        # Spyware
        r'.*spy.*': {'type': 'Spyware', 'severity': 'HIGH', 'family': 'Spyware'},
        r'.*keylog.*': {'type': 'Spyware', 'severity': 'HIGH', 'family': 'Keylogger'},
        r'.*monitor.*': {'type': 'Spyware', 'severity': 'MEDIUM', 'family': 'Activity Monitor'},
        
        # Botnets
        r'.*botnet.*': {'type': 'Botnet', 'severity': 'CRITICAL', 'family': 'Botnet'},
        r'.*bot\.exe.*': {'type': 'Botnet', 'severity': 'CRITICAL', 'family': 'Bot Agent'},
        r'.*zombie.*': {'type': 'Botnet', 'severity': 'HIGH', 'family': 'Zombie'},
        
        # Rootkits
        r'.*rootkit.*': {'type': 'Rootkit', 'severity': 'CRITICAL', 'family': 'Rootkit'},
        r'.*kernel.*': {'type': 'Rootkit', 'severity': 'CRITICAL', 'family': 'Kernel Rootkit'},
        r'.*driver.*': {'type': 'Rootkit', 'severity': 'HIGH', 'family': 'Driver Rootkit'},
        
        # Viruses
        r'.*virus.*': {'type': 'Virus', 'severity': 'HIGH', 'family': 'Generic Virus'},
        r'.*polymorph.*': {'type': 'Virus', 'severity': 'HIGH', 'family': 'Polymorphic Virus'},
        r'.*macro.*': {'type': 'Virus', 'severity': 'MEDIUM', 'family': 'Macro Virus'},
        
        # Adware
        r'.*adware.*': {'type': 'Adware', 'severity': 'MEDIUM', 'family': 'Adware'},
        r'.*popup.*': {'type': 'Adware', 'severity': 'LOW', 'family': 'Popup Generator'},
        r'.*ads.*': {'type': 'Adware', 'severity': 'LOW', 'family': 'Advertisement Injector'},
    },
    
    # Behavioral signatures
    'behavioral_patterns': {
        'high_cpu': {'threshold': 80, 'type': 'CPU Bomb', 'severity': 'MEDIUM'},
        'memory_leak': {'threshold': 1024, 'type': 'Memory Leak', 'severity': 'MEDIUM'},
        'rapid_file_creation': {'rate': 100, 'type': 'File Dropper', 'severity': 'HIGH'},
        'network_scan': {'type': 'Network Scanner', 'severity': 'HIGH'},
        'privilege_escalation': {'type': 'Privilege Escalator', 'severity': 'CRITICAL'},
        'persistence': {'type': 'Persistence Mechanism', 'severity': 'HIGH'},
    },
    
    # Suspicious command patterns
    'command_patterns': {
        r'.*cmd\.exe.*\/c.*': 'Command Execution',
        r'.*powershell.*-encoded.*': 'Encoded PowerShell',
        r'.*wmic.*process.*call.*': 'WMI Process Creation',
        r'.*reg\.exe.*add.*': 'Registry Modification',
        r'.*del.*\/s.*\/q.*': 'Recursive File Deletion',
        r'.*format.*\/s.*': 'Drive Formatting',
    },
    
    # Network signatures
    'network_patterns': {
        r'.*:445$': 'SMB Exploitation',
        r'.*:3389$': 'RDP Brute Force',
        r'.*:22$': 'SSH Attack',
        r'.*:21$': 'FTP Brute Force',
        r'.*\.onion': 'Tor Network',
        r'.*botnet\.cc': 'C&C Server',
    },
}

# ===== MALWARE FAMILIES & PROFILES =====
MALWARE_PROFILES = {
    'trojan_generic': {
        'name': 'Generic Trojan',
        'description': 'Backdoor providing remote access',
        'behaviors': ['persistence', 'remote_access', 'data_exfiltration'],
        'severity': 'CRITICAL',
        'risk_score': 95,
    },
    'ransomware_crypto': {
        'name': 'Crypto-Ransomware',
        'description': 'Encrypts files and demands ransom',
        'behaviors': ['file_encryption', 'ransom_display', 'persistence'],
        'severity': 'CRITICAL',
        'risk_score': 100,
    },
    'worm_propagating': {
        'name': 'Self-Propagating Worm',
        'description': 'Spreads via network shares and removable media',
        'behaviors': ['self_propagation', 'network_spread', 'resource_consumption'],
        'severity': 'HIGH',
        'risk_score': 85,
    },
    'botnet_zombie': {
        'name': 'Botnet Zombie',
        'description': 'Becomes part of botnet for DDoS/spam',
        'behaviors': ['c2_communication', 'ddos', 'spam_sending'],
        'severity': 'CRITICAL',
        'risk_score': 90,
    },
    'spyware_keylogger': {
        'name': 'Keylogger Spyware',
        'description': 'Logs keystrokes and sends to attacker',
        'behaviors': ['keystroke_logging', 'data_exfiltration', 'stealth'],
        'severity': 'HIGH',
        'risk_score': 80,
    },
    'rootkit_kernel': {
        'name': 'Kernel Rootkit',
        'description': 'Hides presence at kernel level',
        'behaviors': ['privilege_escalation', 'stealth', 'persistence'],
        'severity': 'CRITICAL',
        'risk_score': 98,
    },
    'adware_popup': {
        'name': 'Popup Adware',
        'description': 'Generates unwanted advertisements',
        'behaviors': ['ad_injection', 'browser_hijacking', 'data_collection'],
        'severity': 'LOW',
        'risk_score': 30,
    },
    'pup_unwanted': {
        'name': 'Potentially Unwanted Program',
        'description': 'Bundled software with unwanted features',
        'behaviors': ['resource_consumption', 'behavior_modification'],
        'severity': 'LOW',
        'risk_score': 25,
    },
}

# ===== DETECTION RULES =====
DETECTION_RULES = [
    {
        'id': 'RULE_001',
        'name': 'Suspicious Process Name',
        'category': 'Process Anomaly',
        'condition': lambda proc: any(pattern in proc['name'].lower() for pattern in 
                                     ['worm', 'trojan', 'virus', 'ransomware', 'botnet', 'rootkit']),
        'action': 'terminate',
        'severity': 'HIGH',
    },
    {
        'id': 'RULE_002',
        'name': 'Extreme CPU Usage',
        'category': 'Resource Anomaly',
        'condition': lambda proc: proc.get('cpu_percent', 0) > 80,
        'action': 'terminate',
        'severity': 'MEDIUM',
    },
    {
        'id': 'RULE_003',
        'name': 'Memory Spike',
        'category': 'Memory Anomaly',
        'condition': lambda proc: proc.get('memory_mb', 0) > 1024,
        'action': 'monitor',
        'severity': 'MEDIUM',
    },
    {
        'id': 'RULE_004',
        'name': 'System Process Spoofing',
        'category': 'Process Injection',
        'condition': lambda proc: proc['name'].lower().startswith('system') and 'system32' not in proc.get('path', ''),
        'action': 'terminate',
        'severity': 'CRITICAL',
    },
    {
        'id': 'RULE_005',
        'name': 'Multiple Process Instances',
        'category': 'Process Duplication',
        'condition': lambda proc: True,  # Checked separately
        'action': 'alert',
        'severity': 'MEDIUM',
    },
]

# ===== IOC (INDICATORS OF COMPROMISE) =====
INDICATORS_OF_COMPROMISE = {
    'domains': [
        'malware.com',
        'evil-c2.net',
        'botnet-cc.ru',
        'ransomware-pay.info',
        'trojan-home.xyz',
    ],
    'ips': [
        '192.168.1.100',
        '10.0.0.50',
        '172.16.0.1',
        '8.8.8.8',
    ],
    'file_extensions': [
        '.exe', '.dll', '.scr', '.pif', '.bat', '.cmd',
        '.vbs', '.js', '.jar', '.zip', '.rar', '.7z'
    ],
    'registry_keys': [
        r'HKLM\Software\Microsoft\Windows\Run',
        r'HKCU\Software\Microsoft\Windows\Run',
        r'HKLM\System\CurrentControlSet\Services',
    ],
}

# ===== THREAT INTELLIGENCE =====
THREAT_INTELLIGENCE = {
    'known_exploits': [
        {'name': 'EternalBlue', 'cve': 'CVE-2017-0144', 'impact': 'Remote Code Execution'},
        {'name': 'WANNACRY', 'cve': 'CVE-2017-0144', 'impact': 'Ransomware'},
        {'name': 'NotPetya', 'cve': 'CVE-2017-10271', 'impact': 'Worm/Ransomware'},
        {'name': 'Conficker', 'cve': 'CVE-2008-4250', 'impact': 'Worm'},
    ],
    'active_campaigns': [
        {'name': 'Emotet', 'vector': 'Email', 'target': 'Banking'},
        {'name': 'TrickBot', 'vector': 'Email', 'target': 'Financial'},
        {'name': 'Maze', 'vector': 'RDP', 'target': 'Enterprise'},
        {'name': 'Conti', 'vector': 'VPN', 'target': 'Healthcare'},
    ],
}

def get_malware_type(process_name):
    """Identify malware type from process name"""
    import re
    
    for pattern, info in MALWARE_SIGNATURES['process_patterns'].items():
        if re.match(pattern, process_name, re.IGNORECASE):
            return info
    return None

def get_risk_score(detections):
    """Calculate overall risk score"""
    if not detections:
        return 0
    
    scores = [d.get('severity_score', 50) for d in detections]
    return min(100, sum(scores) // len(scores) if scores else 0)

def format_detection(process_name, detection_info):
    """Format detection for display"""
    return {
        'process': process_name,
        'type': detection_info.get('type', 'Unknown'),
        'severity': detection_info.get('severity', 'MEDIUM'),
        'family': detection_info.get('family', 'Unclassified'),
        'risk_score': {'CRITICAL': 90, 'HIGH': 70, 'MEDIUM': 50, 'LOW': 30}.get(
            detection_info.get('severity', 'MEDIUM'), 50
        ),
    }

if __name__ == '__main__':
    print("ðŸš¨ SAFEBOX MALWARE DETECTION DATABASE")
    print("=" * 60)
    print(f"\nâœ… Malware Signatures: {len(MALWARE_SIGNATURES['process_patterns'])} patterns")
    print(f"âœ… Malware Families: {len(MALWARE_PROFILES)} profiles")
    print(f"âœ… Detection Rules: {len(DETECTION_RULES)} rules")
    print(f"âœ… IOC Database: {sum(len(v) for v in INDICATORS_OF_COMPROMISE.values())} indicators")
    print(f"âœ… Threat Intelligence: {len(THREAT_INTELLIGENCE['known_exploits'])} exploits")
    
    print("\nðŸ“Š DETECTION COVERAGE:")
    types = set()
    for info in MALWARE_SIGNATURES['process_patterns'].values():
        types.add(info.get('type', 'Unknown'))
    
    for mtype in sorted(types):
        print(f"   â€¢ {mtype}")
