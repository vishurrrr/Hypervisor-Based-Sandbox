#!/usr/bin/env python3
"""
SafeBox Malware Detection System
Analyzes behavior patterns and detects malicious signatures
"""

import json
import hashlib
import re
from typing import Dict, List, Tuple
from enum import Enum
from dataclasses import dataclass

class ThreatLevel(Enum):
    SAFE = "safe"
    SUSPICIOUS = "suspicious"
    DANGEROUS = "dangerous"
    CRITICAL = "critical"

@dataclass
class MalwareSignature:
    """Malware signature definition"""
    name: str
    description: str
    patterns: List[str]  # Regex patterns
    hashes: List[str]    # Known SHA256 hashes
    threat_level: ThreatLevel
    
class BehaviorIndicator:
    """Indicators of compromise (IOCs)"""
    
    # Suspicious file operations
    SUSPICIOUS_FILE_OPS = [
        r'.*\.exe$',
        r'.*\.dll$',
        r'.*\.sys$',
        r'/proc/mem',
        r'/proc/kmem',
        r'.*\.bat$',
        r'.*\.cmd$',
        r'.*\.scr$'
    ]
    
    # Suspicious registry operations (Windows)
    SUSPICIOUS_REG_OPS = [
        r'HKEY_LOCAL_MACHINE.*\\Run',
        r'HKEY_CURRENT_USER.*\\Run',
        r'Software\\Microsoft\\Windows\\CurrentVersion',
        r'\\System\\CurrentControlSet'
    ]
    
    # Suspicious process operations
    SUSPICIOUS_PROC_OPS = [
        r'CreateRemoteThread',
        r'WriteProcessMemory',
        r'VirtualAllocEx',
        r'SetWindowsHookEx',
        r'ShellExecute',
        r'WinExec'
    ]
    
    # Suspicious network operations
    SUSPICIOUS_NET_OPS = [
        r'cmd.exe.*powershell',
        r'wget.*http',
        r'curl.*http',
        r'nc.*-l.*-p',
        r'telnet.*',
        r'ssh.*key',
        r'scp.*'
    ]
    
    # Suspicious registry modifications
    SUSPICIOUS_REG_MODS = [
        r'DisableRegistryTools',
        r'DisableTaskMgr',
        r'DisableCMD',
        r'DisableRegedit'
    ]

class MalwareDetector:
    """Analyzes programs and files for malware indicators"""
    
    def __init__(self):
        self.known_signatures = self._init_signatures()
        self.threat_score = 0
        self.detections = []
        self.behaviors = []
        
    def _init_signatures(self) -> List[MalwareSignature]:
        """Initialize known malware signatures"""
        signatures = [
            MalwareSignature(
                name="Generic Ransomware",
                description="Detects common ransomware patterns",
                patterns=[
                    r'.*\.encrypt.*',
                    r'.*ransomware.*',
                    r'.*crypt.*exe',
                    r'.*wanna.*cry.*'
                ],
                hashes=[
                    # Known ransomware hashes would go here
                ],
                threat_level=ThreatLevel.CRITICAL
            ),
            MalwareSignature(
                name="Generic Trojan",
                description="Detects common trojan patterns",
                patterns=[
                    r'.*trojan.*',
                    r'.*backdoor.*',
                    r'.*remote.*access.*',
                    r'.*rat\.exe.*'
                ],
                hashes=[],
                threat_level=ThreatLevel.CRITICAL
            ),
            MalwareSignature(
                name="Generic Worm",
                description="Detects worm patterns",
                patterns=[
                    r'.*worm.*',
                    r'.*propagat.*',
                    r'.*replicate.*'
                ],
                hashes=[],
                threat_level=ThreatLevel.DANGEROUS
            ),
            MalwareSignature(
                name="Generic Rootkit",
                description="Detects rootkit patterns",
                patterns=[
                    r'.*rootkit.*',
                    r'.*kernel.*hook.*',
                    r'.*loaddriver.*'
                ],
                hashes=[],
                threat_level=ThreatLevel.CRITICAL
            ),
            MalwareSignature(
                name="Generic Spyware",
                description="Detects spyware patterns",
                patterns=[
                    r'.*spy.*',
                    r'.*keystroke.*',
                    r'.*screenlogger.*',
                    r'.*monitor\.exe.*'
                ],
                hashes=[],
                threat_level=ThreatLevel.DANGEROUS
            )
        ]
        return signatures
    
    def analyze_filename(self, filename: str) -> Tuple[int, List[str]]:
        """Analyze filename for malware indicators"""
        detections = []
        score = 0
        
        filename_lower = filename.lower()
        
        # Check known signatures
        for sig in self.known_signatures:
            for pattern in sig.patterns:
                if re.search(pattern, filename_lower, re.IGNORECASE):
                    detections.append(f"Signature match: {sig.name}")
                    score += self._threat_score(sig.threat_level)
        
        # Check suspicious file extensions
        if filename.endswith(('.exe', '.dll', '.sys', '.bat', '.cmd', '.scr', '.ps1')):
            detections.append("Executable file detected")
            score += 20
        
        # Check for obfuscation patterns
        if re.search(r'[^a-zA-Z0-9_\-\.]', filename):
            detections.append("Suspicious characters in filename")
            score += 10
        
        return score, detections
    
    def analyze_file_hash(self, file_hash: str) -> Tuple[int, List[str]]:
        """Analyze file hash against known malware hashes"""
        detections = []
        score = 0
        
        # Check against known signatures
        for sig in self.known_signatures:
            if file_hash in sig.hashes:
                detections.append(f"Hash match: {sig.name}")
                score += self._threat_score(sig.threat_level)
        
        return score, detections
    
    def analyze_behavior(self, behaviors: List[str]) -> Tuple[int, List[str]]:
        """Analyze behavior patterns for malware indicators"""
        detections = []
        score = 0
        
        behavior_text = ' '.join(behaviors).lower()
        
        # Check file operations
        for pattern in BehaviorIndicator.SUSPICIOUS_FILE_OPS:
            if re.search(pattern, behavior_text):
                detections.append(f"Suspicious file operation: {pattern}")
                score += 15
        
        # Check process operations
        for pattern in BehaviorIndicator.SUSPICIOUS_PROC_OPS:
            if re.search(pattern, behavior_text):
                detections.append(f"Suspicious process operation: {pattern}")
                score += 20
        
        # Check network operations
        for pattern in BehaviorIndicator.SUSPICIOUS_NET_OPS:
            if re.search(pattern, behavior_text):
                detections.append(f"Suspicious network operation: {pattern}")
                score += 25
        
        # Check for persistence mechanisms
        if 'auto-start' in behavior_text or 'startup' in behavior_text:
            detections.append("Persistence mechanism detected")
            score += 30
        
        # Check for privilege escalation
        if 'privilege' in behavior_text or 'admin' in behavior_text:
            detections.append("Privilege escalation attempt detected")
            score += 35
        
        return score, detections
    
    def analyze_resource_usage(self, cpu: float, memory: float, num_processes: int) -> Tuple[int, List[str]]:
        """Analyze resource usage patterns for malware indicators"""
        detections = []
        score = 0
        
        # High CPU usage
        if cpu > 80:
            detections.append(f"Excessive CPU usage: {cpu}%")
            score += 15
        
        # High memory usage
        if memory > 500:
            detections.append(f"Excessive memory usage: {memory:.1f}MB")
            score += 15
        
        # Too many processes
        if num_processes > 20:
            detections.append(f"Excessive process creation: {num_processes}")
            score += 20
        
        # Crypto mining indicators
        if cpu > 70 and memory < 100:
            detections.append("Possible crypto mining activity")
            score += 25
        
        return score, detections
    
    def scan(self, filename: str = None, file_hash: str = None, 
            behaviors: List[str] = None, cpu: float = 0, 
            memory: float = 0, num_processes: int = 0) -> Dict:
        """Comprehensive scan of file/behavior"""
        total_score = 0
        all_detections = []
        
        # Analyze filename
        if filename:
            score, dets = self.analyze_filename(filename)
            total_score += score
            all_detections.extend(dets)
        
        # Analyze hash
        if file_hash:
            score, dets = self.analyze_file_hash(file_hash)
            total_score += score
            all_detections.extend(dets)
        
        # Analyze behaviors
        if behaviors:
            score, dets = self.analyze_behavior(behaviors)
            total_score += score
            all_detections.extend(dets)
        
        # Analyze resource usage
        score, dets = self.analyze_resource_usage(cpu, memory, num_processes)
        total_score += score
        all_detections.extend(dets)
        
        # Determine threat level
        threat_level = self._score_to_threat(total_score)
        
        self.threat_score = total_score
        self.detections = all_detections
        
        return {
            'threat_score': total_score,
            'threat_level': threat_level.value,
            'detections': all_detections,
            'risk': self._get_risk_assessment(total_score)
        }
    
    @staticmethod
    def _threat_score(level: ThreatLevel) -> int:
        """Convert threat level to score"""
        scores = {
            ThreatLevel.SAFE: 0,
            ThreatLevel.SUSPICIOUS: 20,
            ThreatLevel.DANGEROUS: 50,
            ThreatLevel.CRITICAL: 100
        }
        return scores.get(level, 0)
    
    @staticmethod
    def _score_to_threat(score: int) -> ThreatLevel:
        """Convert score to threat level"""
        if score >= 150:
            return ThreatLevel.CRITICAL
        elif score >= 100:
            return ThreatLevel.DANGEROUS
        elif score >= 30:
            return ThreatLevel.SUSPICIOUS
        else:
            return ThreatLevel.SAFE
    
    @staticmethod
    def _get_risk_assessment(score: int) -> str:
        """Get risk assessment text"""
        if score >= 150:
            return "EXTREMELY HIGH RISK - IMMEDIATE ISOLATION RECOMMENDED"
        elif score >= 100:
            return "HIGH RISK - ISOLATION RECOMMENDED"
        elif score >= 30:
            return "MEDIUM RISK - MONITOR CLOSELY"
        else:
            return "LOW RISK - APPEARS SAFE"

if __name__ == '__main__':
    detector = MalwareDetector()
    print("SafeBox Malware Detection System")
